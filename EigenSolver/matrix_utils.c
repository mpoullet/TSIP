/*****************************************************************
 *
 * File........:	matrix_utils.c
 * Function....:	special functions for matrices
 * Author......:	Tilo Strutz
 * last changes:	20.10.2009, 01.01.2011, 29.3.2011
 *
 * LICENCE DETAILS: see software manual
 *	free academic use
 *  cite source as 
 * "Strutz, T.: Data Fitting and Uncertainty. Vieweg+Teubner, 2010"
 *
 *****************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "errmsg.h"

/*---------------------------------------------------------------
 *	vector()
 *	create a vector with subscript range v[0..N-1]
 *--------------------------------------------------------------*/
double *vector( long N)
{
	int err = 0;
	double *v;

	v = (double*)calloc( N, sizeof(double));
	if (v == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "vector", " ", 0);
		exit( err);
	}
	return v;
}

/*---------------------------------------------------------------
 *	fvector()
 *	create a vector with subscript range v[0..N-1]
 *--------------------------------------------------------------*/
float *fvector( long N)
{
	int err = 0;
	float *v;

	v = (float*)calloc( N, sizeof(float));
	if (v == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "vector", " ", 0);
		exit( err);
	}
	return v;
}

/*---------------------------------------------------------------
 *	ivector()
 *	create a vector with subscript range v[0..N-1]
 *--------------------------------------------------------------*/
int *
ivector( long N)
{
	int err = 0;
	int *v;

	v = (int*)calloc( N, sizeof(int));
	if (v == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "vector", " ", 0);
		exit( err);
	}
	return v;
}
/*---------------------------------------------------------------
 *	uivector()
 *	create a vector with subscript range v[0..N-1]
 *--------------------------------------------------------------*/
unsigned int *
uivector( long N)
{
	int err = 0;
	unsigned int *v;

	v = (unsigned int*)calloc( N, sizeof(unsigned int));
	if (v == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "vector", " ", 0);
		exit( err);
	}
	return v;
}

/*---------------------------------------------------------------
 *	matrix()
 *	create a matrix with subscript range v[0..M-1][0..N-1]
 *--------------------------------------------------------------*/
double **
matrix( long N, long M)
{
	int err = 0;
	long i;
	double **m;

	/* allocate pointers to rows */
	m = (double **)malloc( N * sizeof(double*));
	if (m == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "matrix", " ", 0);
		exit( err);
	}

	/* allocate rows and set pointers to them */
	m[0] = (double*)calloc( M * N, sizeof(double));
	if (m[0] == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "matrix", " ", 0);
		exit( err);
	}

	for (i = 1; i < N; i++)
	{
		m[i] = m[i - 1] + M;
	}

	/* return pointer to array of pointers to rows */
	return m;
}
/*---------------------------------------------------------------
 *	fmatrix()
 *	create a matrix with subscript range v[0..M-1][0..N-1]
 *--------------------------------------------------------------*/
float **
fmatrix( long N, long M)
{
	int err = 0;
	long i;
	float **m;

	/* allocate pointers to rows */
	m = (float **)malloc( N * sizeof(float*));
	if (m == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "matrix", " ", 0);
		exit( err);
	}

	/* allocate rows and set pointers to them */
	m[0] = (float*)calloc( M * N, sizeof(float));
	if (m[0] == NULL)
	{
		err = errmsg( ERR_ALLOCATE, "matrix", " ", 0);
		exit( err);
	}

	for (i = 1; i < N; i++)
	{
		m[i] = m[i - 1] + M;
	}

	/* return pointer to array of pointers to rows */
	return m;
}

/*---------------------------------------------------------------
 * free a vector allocated by vector()
 *--------------------------------------------------------------*/
void
free_vector( double *v[])
{
	if (*v != NULL)
		free( *v);
	*v = NULL;
}

/*---------------------------------------------------------------
 * free a vector allocated by ivector()
 *--------------------------------------------------------------*/
void
free_ivector( int *v[])
{
	if (*v != NULL)
		free( *v);
	*v = NULL;
}
/*---------------------------------------------------------------
 * free a vector allocated by uivector()
 *--------------------------------------------------------------*/
void
free_uivector( unsigned int *v[])
{
	if (*v != NULL)
		free( *v);
	*v = NULL;
}

/*---------------------------------------------------------------
 * free a matrix allocated by matrix()
 *--------------------------------------------------------------*/
void
free_matrix( double **m[])
{

	if (*m != NULL)
	{
		if (*m[0] != NULL)
			free( *m[0]);
		free( *m);
	}
	*m = NULL;
}

/*---------------------------------------------------------------
 * free a matrix allocated by fmatrix()
 *--------------------------------------------------------------*/
void
free_fmatrix( float **m[])
{

	if (*m != NULL)
	{
		if (*m[0] != NULL)
			free( *m[0]);
		free( *m);
	}
	*m = NULL;
}

/*---------------------------------------------------------------
 *	determinant_2x2()
 *--------------------------------------------------------------*/
double
determinant_2x2( double **a)
{
	return a[0][0] * a[1][1] - a[0][1] * a[1][0];
}

/*---------------------------------------------------------------
 *	determinant_3x3()
 *--------------------------------------------------------------*/
double
determinant_3x3( double **a)
{
	/* The numerical stability depends on the order of operations.
	 * The discrimination below works for the mentioned data sets
	 * in Release mode, but should evaluated in more detail
	 */
	if (fabs(a[0][0]) < 1)
		return
			/* better performance for Eckerle4.dat	*/
			(
			a[0][0] * (a[1][1] * a[2][2] - a[2][1] * a[1][2]) -
			a[0][1] * (a[1][0] * a[2][2] + a[2][0] * a[1][2])
			) +
			a[0][2] * (a[1][0] * a[2][1] - a[2][0] * a[1][1]);
	else
		return
			/* better performance for MGH10.dat*/
			a[0][0] * a[1][1] * a[2][2] - a[0][0] * a[2][1] * a[1][2] -
			a[0][1] * a[1][0] * a[2][2] + a[0][1] * a[2][0] * a[1][2] +
			a[0][2] * a[1][0] * a[2][1] - a[0][2] * a[2][0] * a[1][1];
}

/*---------------------------------------------------------------
 *	inverse_5x5()
 * get the inverse of a square 5x5 matrix
 * returns determinant
 *--------------------------------------------------------------*/
double
inverse_5x5( double **a, double **b)
{
	double det;

	det = 
		a[0][0] * (
			a[1][1] * (+a[2][2]*a[3][3]*a[4][4] - a[2][2]*a[4][3]*a[3][4]
								 -a[3][2]*a[2][3]*a[4][4] - a[3][3]*a[4][2]*a[2][4]
								 +a[4][2]*a[2][3]*a[3][4] + a[4][3]*a[3][2]*a[2][4] ) +
			a[2][2] * (-a[3][1]*a[1][3]*a[4][4] - a[3][3]*a[4][1]*a[1][4]
								 +a[4][1]*a[1][3]*a[3][4] + a[4][3]*a[3][1]*a[1][4] ) +
			a[3][1] * (+a[1][2]*a[2][3]*a[4][4] + a[1][3]*a[4][2]*a[2][4] ) +
			a[3][2] * (+a[2][1]*a[1][3]*a[4][4] + a[2][3]*a[4][1]*a[1][4] ) +
			a[3][3] * (-a[2][1]*a[1][2]*a[4][4] + a[4][1]*a[1][2]*a[2][4] 
								 +a[4][2]*a[2][1]*a[1][4] ) +
			a[4][1] * (-a[1][2]*a[2][3]*a[3][4] - a[1][3]*a[3][2]*a[2][4] ) +
			a[4][2] * (-a[2][1]*a[1][3]*a[3][4] - a[2][3]*a[3][1]*a[1][4] ) +
			a[4][3] * (+a[2][1]*a[1][2]*a[3][4] - a[3][1]*a[1][2]*a[2][4] 
								 -a[3][2]*a[2][1]*a[1][4] )
							) +
		a[1][1] * (
			a[2][2] * (-a[3][0]*a[0][3]*a[4][4] - a[3][3]*a[4][0]*a[0][4]
								 +a[4][0]*a[0][3]*a[3][4] + a[4][3]*a[3][0]*a[0][4] ) +
			a[3][0] * (+a[0][2]*a[2][3]*a[4][4] + a[0][3]*a[4][2]*a[2][4] ) +
			a[3][2] * (+a[2][0]*a[0][3]*a[4][4] + a[2][3]*a[4][0]*a[0][4] ) +
			a[3][3] * (-a[2][0]*a[0][2]*a[4][4] + a[4][0]*a[0][2]*a[2][4] 
								 +a[4][2]*a[2][0]*a[0][4] ) +
			a[4][0] * (-a[0][2]*a[2][3]*a[3][4] - a[0][3]*a[3][2]*a[2][4] ) +
			a[4][2] * (-a[2][0]*a[0][3]*a[3][4] - a[2][3]*a[3][0]*a[0][4] ) +
			a[4][3] * (+a[2][0]*a[0][2]*a[3][4] - a[3][0]*a[0][2]*a[2][4] 
								 -a[3][2]*a[2][0]*a[0][4] ) 
						) +
		a[2][2] * (
			a[3][0] * (+a[0][1]*a[1][3]*a[4][4] + a[0][3]*a[4][1]*a[1][4] ) +
			a[3][1] * (+a[1][0]*a[0][3]*a[4][4] + a[1][3]*a[4][0]*a[0][4] ) +
			a[3][3] * (-a[1][0]*a[0][1]*a[4][4] + a[4][0]*a[0][1]*a[1][4] 
								 +a[4][1]*a[1][0]*a[0][4] ) +
			a[4][0] * (-a[0][1]*a[1][3]*a[3][4] - a[0][3]*a[3][1]*a[1][4] ) +
			a[4][1] * (-a[1][0]*a[0][3]*a[3][4] - a[1][3]*a[3][0]*a[0][4] ) +
			a[4][3] * (+a[1][0]*a[0][1]*a[3][4] - a[3][0]*a[0][1]*a[1][4] 
								 -a[3][1]*a[1][0]*a[0][4] )
							) +
		a[3][0] * (
			a[0][1] * (-a[1][2]*a[2][3]*a[4][4] - a[1][3]*a[4][2]*a[2][4] ) +
			a[0][2] * (-a[2][1]*a[1][3]*a[4][4] - a[2][3]*a[4][1]*a[1][4] ) +
			a[0][3] * (+a[2][1]*a[1][2]*a[4][4] - a[4][1]*a[1][2]*a[2][4] 
								 -a[4][2]*a[2][1]*a[1][4] )
							) +
		a[3][1] * (
			a[1][0] * (-a[0][2]*a[2][3]*a[4][4] - a[0][3]*a[4][2]*a[2][4] ) +
			a[1][2] * (-a[2][0]*a[0][3]*a[4][4] - a[2][3]*a[4][0]*a[0][4] ) +
			a[1][3] * (+a[2][0]*a[0][2]*a[4][4] - a[4][0]*a[0][2]*a[2][4] 
								 -a[4][2]*a[2][0]*a[0][4] )
							) +
		a[3][2] * (
			a[2][0] * (-a[0][1]*a[1][3]*a[4][4] - a[0][3]*a[4][1]*a[1][4] ) +
			a[2][1] * (-a[1][0]*a[0][3]*a[4][4] - a[1][3]*a[4][0]*a[0][4] ) +
			a[2][3] * (+a[1][0]*a[0][1]*a[4][4] - a[4][0]*a[0][1]*a[1][4]
								 -a[4][1]*a[1][0]*a[0][4] )
							) +
		a[3][3] * (
			a[2][0] * (+a[0][1]*a[1][2]*a[4][4] + a[0][2]*a[4][1]*a[1][4] ) +
			a[2][1] * (+a[1][0]*a[0][2]*a[4][4] + a[1][2]*a[4][0]*a[0][4] ) +
			a[4][0] * (-a[0][1]*a[1][2]*a[2][4] - a[0][2]*a[2][1]*a[1][4] ) +
			a[4][1] * (-a[1][0]*a[0][2]*a[2][4] - a[1][2]*a[2][0]*a[0][4] ) +
			a[4][2] * (+a[1][0]*a[0][1]*a[2][4] - a[2][0]*a[0][1]*a[1][4]
								 -a[2][1]*a[1][0]*a[0][4] )
							) +
		a[4][0] * (
			a[0][1] * (+a[1][2]*a[2][3]*a[3][4] + a[1][3]*a[3][2]*a[2][4] ) +
			a[0][2] * (+a[2][1]*a[1][3]*a[3][4] + a[2][3]*a[3][1]*a[1][4] ) +
			a[0][3] * (-a[2][1]*a[1][2]*a[3][4] + a[3][1]*a[1][2]*a[2][4] 
								 +a[3][2]*a[2][1]*a[1][4] )
							) +
		a[4][1] * (
			a[1][0] * (+a[0][2]*a[2][3]*a[3][4] + a[0][3]*a[3][2]*a[2][4] ) +
			a[1][2] * (+a[2][0]*a[0][3]*a[3][4] + a[2][3]*a[3][0]*a[0][4] ) +
			a[1][3] * (-a[2][0]*a[0][2]*a[3][4] + a[3][0]*a[0][2]*a[2][4] 
								 +a[3][2]*a[2][0]*a[0][4] )
							) +
		a[4][2] * (
			a[2][0] * (+a[0][1]*a[1][3]*a[3][4] + a[0][3]*a[3][1]*a[1][4] ) +
			a[2][1] * (+a[1][0]*a[0][3]*a[3][4] + a[1][3]*a[3][0]*a[0][4] ) +
			a[2][3] * (-a[1][0]*a[0][1]*a[3][4] + a[3][1]*a[1][0]*a[0][4] 
								 +a[3][0]*a[0][1]*a[1][4] )
							) +
		a[4][3] * (
			a[2][0] * (-a[0][1]*a[1][2]*a[3][4] - a[0][2]*a[3][1]*a[1][4] ) +
			a[2][1] * (-a[1][0]*a[0][2]*a[3][4] - a[1][2]*a[3][0]*a[0][4] ) +
			a[3][0] * (+a[0][1]*a[1][2]*a[2][4] + a[0][2]*a[2][1]*a[1][4] )+
			a[3][1] * (+a[1][0]*a[0][2]*a[2][4] + a[1][2]*a[2][0]*a[0][4] )+
			a[3][2] * (-a[1][0]*a[0][1]*a[2][4] + a[2][0]*a[0][1]*a[1][4] 
								 +a[2][1]*a[1][0]*a[0][4] )
							);

	 b[0][0] = -(
		 a[1][1] * ( 
								a[2][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[1][2] * ( 
								a[2][1] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][4] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1])
								)+
		 a[1][3] * ( 
								a[2][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[1][4] * ( 
								a[2][1] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[2][3] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1])
								));

	 b[0][1] =
		 a[0][1] * ( 
								a[2][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[0][2] * ( 
								a[2][1] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][4] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1])
								)+
		 a[0][3] * ( 
								a[2][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[0][4] * ( 
								a[2][1] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[2][3] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1])
								);

	 b[0][2] =
		 a[1][1] * ( 
								a[0][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[0][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[0][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[1][2] * ( 
								a[0][1] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[0][3] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[0][4] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1])
								)+
		 a[1][3] * ( 
								a[0][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[0][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[0][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[1][4] * ( 
								a[0][1] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[0][2] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[0][3] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1])
								);

	 b[0][3] = +(
		 a[1][1] * ( 
								a[2][2] * (-a[0][3]*a[4][4] + a[0][4]*a[4][3]) +
								a[2][3] * (+a[0][2]*a[4][4] - a[0][4]*a[4][2]) +
								a[2][4] * (-a[0][2]*a[4][3] + a[0][3]*a[4][2])
								)+
		 a[1][2] * ( 
								a[2][1] * (+a[0][3]*a[4][4] - a[0][4]*a[4][3]) +
								a[2][3] * (-a[0][1]*a[4][4] + a[0][4]*a[4][1]) +
								a[2][4] * (+a[0][1]*a[4][3] - a[0][3]*a[4][1])
								)+
		 a[1][3] * ( 
								a[2][1] * (-a[0][2]*a[4][4] + a[0][4]*a[4][2]) +
								a[2][2] * (+a[0][1]*a[4][4] - a[0][4]*a[4][1]) +
								a[2][4] * (-a[0][1]*a[4][2] + a[0][2]*a[4][1])
								)+
		 a[1][4] * ( 
								a[2][1] * (+a[0][2]*a[4][3] - a[0][3]*a[4][2]) +
								a[2][2] * (-a[0][1]*a[4][3] + a[0][3]*a[4][1]) +
								a[2][3] * (+a[0][1]*a[4][2] - a[0][2]*a[4][1])
								));

	 b[0][4] =
		 a[1][1] * ( 
								a[2][2] * (-a[3][3]*a[0][4] + a[3][4]*a[0][3]) +
								a[2][3] * (+a[3][2]*a[0][4] - a[3][4]*a[0][2]) +
								a[2][4] * (-a[3][2]*a[0][3] + a[3][3]*a[0][2])
								)+
		 a[1][2] * ( 
								a[2][1] * (+a[3][3]*a[0][4] - a[3][4]*a[0][3]) +
								a[2][3] * (-a[3][1]*a[0][4] + a[3][4]*a[0][1]) +
								a[2][4] * (+a[3][1]*a[0][3] - a[3][3]*a[0][1])
								)+
		 a[1][3] * ( 
								a[2][1] * (-a[3][2]*a[0][4] + a[3][4]*a[0][2]) +
								a[2][2] * (+a[3][1]*a[0][4] - a[3][4]*a[0][1]) +
								a[2][4] * (-a[3][1]*a[0][2] + a[3][2]*a[0][1])
								)+
		 a[1][4] * ( 
								a[2][1] * (+a[3][2]*a[0][3] - a[3][3]*a[0][2]) +
								a[2][2] * (-a[3][1]*a[0][3] + a[3][3]*a[0][1]) +
								a[2][3] * (+a[3][1]*a[0][2] - a[3][2]*a[0][1])
								);
	/* second row	*/
	 b[1][0] =
		 a[1][0] * ( 
								a[2][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[1][2] * ( 
								a[2][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[1][3] * ( 
								a[2][0] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0])
								)+
		 a[1][4] * ( 
								a[2][0] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[2][3] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								);

	 b[1][1] = -(
		 a[0][0] * ( 
								a[2][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[0][2] * ( 
								a[2][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[2][0] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0])
								)+
		 a[0][4] * ( 
								a[2][0] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[2][3] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								));

	 b[1][2] = +(
		 a[0][0] * ( 
								a[1][2] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[1][3] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[1][4] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[0][2] * ( 
								a[1][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[1][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[1][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[1][2] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[1][4] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[1][2] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[1][3] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								));

	 b[1][3] = -(
		 a[0][0] * ( 
								a[1][2] * (-a[2][3]*a[4][4] + a[2][4]*a[4][3]) +
								a[1][3] * (+a[2][2]*a[4][4] - a[2][4]*a[4][2]) +
								a[1][4] * (-a[2][2]*a[4][3] + a[2][3]*a[4][2])
								)+
		 a[0][2] * ( 
								a[1][0] * (+a[2][3]*a[4][4] - a[2][4]*a[4][3]) +
								a[1][3] * (-a[2][0]*a[4][4] + a[2][4]*a[4][0]) +
								a[1][4] * (+a[2][0]*a[4][3] - a[2][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[2][2]*a[4][4] + a[2][4]*a[4][2]) +
								a[1][2] * (+a[2][0]*a[4][4] - a[2][4]*a[4][0]) +
								a[1][4] * (-a[2][0]*a[4][2] + a[2][2]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][2]*a[4][3] - a[2][3]*a[4][2]) +
								a[1][2] * (-a[2][0]*a[4][3] + a[2][3]*a[4][0]) +
								a[1][3] * (+a[2][0]*a[4][2] - a[2][2]*a[4][0])
								));

	 b[1][4] = +(
		 a[0][0] * ( 
								a[1][2] * (-a[2][3]*a[3][4] + a[2][4]*a[3][3]) +
								a[1][3] * (+a[2][2]*a[3][4] - a[2][4]*a[3][2]) +
								a[1][4] * (-a[2][2]*a[3][3] + a[2][3]*a[3][2])
								)+
		 a[0][2] * ( 
								a[1][0] * (+a[2][3]*a[3][4] - a[2][4]*a[3][3]) +
								a[1][3] * (-a[2][0]*a[3][4] + a[2][4]*a[3][0]) +
								a[1][4] * (+a[2][0]*a[3][3] - a[2][3]*a[3][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[2][2]*a[3][4] + a[2][4]*a[3][2]) +
								a[1][2] * (+a[2][0]*a[3][4] - a[2][4]*a[3][0]) +
								a[1][4] * (-a[2][0]*a[3][2] + a[2][2]*a[3][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][2]*a[3][3] - a[2][3]*a[3][2]) +
								a[1][2] * (-a[2][0]*a[3][3] + a[2][3]*a[3][0]) +
								a[1][3] * (+a[2][0]*a[3][2] - a[2][2]*a[3][0])
								));
	/* third row	*/
	 b[2][0] = -(
		 a[1][0] * ( 
								a[2][1] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1])
								)+
		 a[1][1] * ( 
								a[2][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[1][3] * ( 
								a[2][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[1][4] * ( 
								a[2][0] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1]) +
								a[2][1] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[2][3] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[2][1] = +(
		 a[0][0] * ( 
								a[2][1] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[2][3] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1])
								)+
		 a[0][1] * ( 
								a[2][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[2][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[2][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[2][0] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1]) +
								a[2][1] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[2][3] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[2][2] = -(
		 a[0][0] * ( 
								a[1][1] * (-a[3][3]*a[4][4] + a[3][4]*a[4][3]) +
								a[1][3] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[1][4] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[3][3]*a[4][4] - a[3][4]*a[4][3]) +
								a[1][3] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[1][4] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[1][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[1][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1]) +
								a[1][1] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[1][3] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[2][3] = +(
		 a[0][0] * ( 
								a[1][1] * (-a[2][3]*a[4][4] + a[2][4]*a[4][3]) +
								a[1][3] * (+a[2][1]*a[4][4] - a[2][4]*a[4][1]) +
								a[1][4] * (-a[2][1]*a[4][3] + a[2][3]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][3]*a[4][4] - a[2][4]*a[4][3]) +
								a[1][3] * (-a[2][0]*a[4][4] + a[2][4]*a[4][0]) +
								a[1][4] * (+a[2][0]*a[4][3] - a[2][3]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[2][1]*a[4][4] + a[2][4]*a[4][1]) +
								a[1][1] * (+a[2][0]*a[4][4] - a[2][4]*a[4][0]) +
								a[1][4] * (-a[2][0]*a[4][1] + a[2][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][1]*a[4][3] - a[2][3]*a[4][1]) +
								a[1][1] * (-a[2][0]*a[4][3] + a[2][3]*a[4][0]) +
								a[1][3] * (+a[2][0]*a[4][1] - a[2][1]*a[4][0])
								));

	 b[2][4] = -(
		 a[0][0] * ( 
								a[1][1] * (-a[2][3]*a[3][4] + a[2][4]*a[3][3]) +
								a[1][3] * (+a[2][1]*a[3][4] - a[2][4]*a[3][1]) +
								a[1][4] * (-a[2][1]*a[3][3] + a[2][3]*a[3][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][3]*a[3][4] - a[2][4]*a[3][3]) +
								a[1][3] * (-a[2][0]*a[3][4] + a[2][4]*a[3][0]) +
								a[1][4] * (+a[2][0]*a[3][3] - a[2][3]*a[3][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (-a[2][1]*a[3][4] + a[2][4]*a[3][1]) +
								a[1][1] * (+a[2][0]*a[3][4] - a[2][4]*a[3][0]) +
								a[1][4] * (-a[2][0]*a[3][1] + a[2][1]*a[3][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][1]*a[3][3] - a[2][3]*a[3][1]) +
								a[1][1] * (-a[2][0]*a[3][3] + a[2][3]*a[3][0]) +
								a[1][3] * (+a[2][0]*a[3][1] - a[2][1]*a[3][0])
								));

	/* fourth row	*/
	 b[3][0] = +(
		 a[1][0] * ( 
								a[2][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[1][1] * ( 
								a[2][0] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][2] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								)+
		 a[1][2] * ( 
								a[2][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[1][4] * ( 
								a[2][0] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1]) +
								a[2][1] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0]) +
								a[2][2] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[3][1] = -(
		 a[0][0] * ( 
								a[2][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[2][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[2][0] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[2][2] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[2][4] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[2][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[2][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[2][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[2][0] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1]) +
								a[2][1] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0]) +
								a[2][2] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[3][2] = +(
		 a[0][0] * ( 
								a[1][1] * (-a[3][2]*a[4][4] + a[3][4]*a[4][2]) +
								a[1][2] * (+a[3][1]*a[4][4] - a[3][4]*a[4][1]) +
								a[1][4] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[3][2]*a[4][4] - a[3][4]*a[4][2]) +
								a[1][2] * (-a[3][0]*a[4][4] + a[3][4]*a[4][0]) +
								a[1][4] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[3][1]*a[4][4] + a[3][4]*a[4][1]) +
								a[1][1] * (+a[3][0]*a[4][4] - a[3][4]*a[4][0]) +
								a[1][4] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1]) +
								a[1][1] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0]) +
								a[1][2] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[3][3] = -(
		 a[0][0] * ( 
								a[1][1] * (-a[2][2]*a[4][4] + a[2][4]*a[4][2]) +
								a[1][2] * (+a[2][1]*a[4][4] - a[2][4]*a[4][1]) +
								a[1][4] * (-a[2][1]*a[4][2] + a[2][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][2]*a[4][4] - a[2][4]*a[4][2]) +
								a[1][2] * (-a[2][0]*a[4][4] + a[2][4]*a[4][0]) +
								a[1][4] * (+a[2][0]*a[4][2] - a[2][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[2][1]*a[4][4] + a[2][4]*a[4][1]) +
								a[1][1] * (+a[2][0]*a[4][4] - a[2][4]*a[4][0]) +
								a[1][4] * (-a[2][0]*a[4][1] + a[2][1]*a[4][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][1]*a[4][2] - a[2][2]*a[4][1]) +
								a[1][1] * (-a[2][0]*a[4][2] + a[2][2]*a[4][0]) +
								a[1][2] * (+a[2][0]*a[4][1] - a[2][1]*a[4][0])
								));

	 b[3][4] = +(
		 a[0][0] * ( 
								a[1][1] * (-a[2][2]*a[3][4] + a[2][4]*a[3][2]) +
								a[1][2] * (+a[2][1]*a[3][4] - a[2][4]*a[3][1]) +
								a[1][4] * (-a[2][1]*a[3][2] + a[2][2]*a[3][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][2]*a[3][4] - a[2][4]*a[3][2]) +
								a[1][2] * (-a[2][0]*a[3][4] + a[2][4]*a[3][0]) +
								a[1][4] * (+a[2][0]*a[3][2] - a[2][2]*a[3][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[2][1]*a[3][4] + a[2][4]*a[3][1]) +
								a[1][1] * (+a[2][0]*a[3][4] - a[2][4]*a[3][0]) +
								a[1][4] * (-a[2][0]*a[3][1] + a[2][1]*a[3][0])
								)+
		 a[0][4] * ( 
								a[1][0] * (+a[2][1]*a[3][2] - a[2][2]*a[3][1]) +
								a[1][1] * (-a[2][0]*a[3][2] + a[2][2]*a[3][0]) +
								a[1][2] * (+a[2][0]*a[3][1] - a[2][1]*a[3][0])
								));

	/* fifth row	*/
	 b[4][0] = +(
		 a[1][1] * ( 
								a[2][2] * (-a[3][3]*a[4][0] + a[3][0]*a[4][3]) +
								a[2][3] * (+a[3][2]*a[4][0] - a[3][0]*a[4][2]) +
								a[2][0] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2])
								)+
		 a[1][2] * ( 
								a[2][1] * (+a[3][3]*a[4][0] - a[3][0]*a[4][3]) +
								a[2][3] * (-a[3][1]*a[4][0] + a[3][0]*a[4][1]) +
								a[2][0] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1])
								)+
		 a[1][3] * ( 
								a[2][1] * (-a[3][2]*a[4][0] + a[3][0]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][0] - a[3][0]*a[4][1]) +
								a[2][0] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[1][0] * ( 
								a[2][1] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[2][3] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1])
								));

	 b[4][1] = +(
		 a[0][0] * ( 
								a[2][1] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2]) +
								a[2][2] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1]) +
								a[2][3] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[2][0] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[2][2] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[2][3] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[2][0] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[2][1] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0]) +
								a[2][3] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][3] * ( 
								a[2][0] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1]) +
								a[2][1] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0]) +
								a[2][2] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[4][2] = -(
		 a[0][0] * ( 
								a[1][1] * (-a[3][2]*a[4][3] + a[3][3]*a[4][2]) +
								a[1][2] * (+a[3][1]*a[4][3] - a[3][3]*a[4][1]) +
								a[1][3] * (-a[3][1]*a[4][2] + a[3][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[3][2]*a[4][3] - a[3][3]*a[4][2]) +
								a[1][2] * (-a[3][0]*a[4][3] + a[3][3]*a[4][0]) +
								a[1][3] * (+a[3][0]*a[4][2] - a[3][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[3][1]*a[4][3] + a[3][3]*a[4][1]) +
								a[1][1] * (+a[3][0]*a[4][3] - a[3][3]*a[4][0]) +
								a[1][3] * (-a[3][0]*a[4][1] + a[3][1]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (+a[3][1]*a[4][2] - a[3][2]*a[4][1]) +
								a[1][1] * (-a[3][0]*a[4][2] + a[3][2]*a[4][0]) +
								a[1][2] * (+a[3][0]*a[4][1] - a[3][1]*a[4][0])
								));

	 b[4][3] = +(
		 a[0][0] * ( 
								a[1][1] * (-a[2][2]*a[4][3] + a[2][3]*a[4][2]) +
								a[1][2] * (+a[2][1]*a[4][3] - a[2][3]*a[4][1]) +
								a[1][3] * (-a[2][1]*a[4][2] + a[2][2]*a[4][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][2]*a[4][3] - a[2][3]*a[4][2]) +
								a[1][2] * (-a[2][0]*a[4][3] + a[2][3]*a[4][0]) +
								a[1][3] * (+a[2][0]*a[4][2] - a[2][2]*a[4][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[2][1]*a[4][3] + a[2][3]*a[4][1]) +
								a[1][1] * (+a[2][0]*a[4][3] - a[2][3]*a[4][0]) +
								a[1][3] * (-a[2][0]*a[4][1] + a[2][1]*a[4][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (+a[2][1]*a[4][2] - a[2][2]*a[4][1]) +
								a[1][1] * (-a[2][0]*a[4][2] + a[2][2]*a[4][0]) +
								a[1][2] * (+a[2][0]*a[4][1] - a[2][1]*a[4][0])
								));

	 b[4][4] = -(
		 a[0][0] * ( 
								a[1][1] * (-a[2][2]*a[3][3] + a[2][3]*a[3][2]) +
								a[1][2] * (+a[2][1]*a[3][3] - a[2][3]*a[3][1]) +
								a[1][3] * (-a[2][1]*a[3][2] + a[2][2]*a[3][1])
								)+
		 a[0][1] * ( 
								a[1][0] * (+a[2][2]*a[3][3] - a[2][3]*a[3][2]) +
								a[1][2] * (-a[2][0]*a[3][3] + a[2][3]*a[3][0]) +
								a[1][3] * (+a[2][0]*a[3][2] - a[2][2]*a[3][0])
								)+
		 a[0][2] * ( 
								a[1][0] * (-a[2][1]*a[3][3] + a[2][3]*a[3][1]) +
								a[1][1] * (+a[2][0]*a[3][3] - a[2][3]*a[3][0]) +
								a[1][3] * (-a[2][0]*a[3][1] + a[2][1]*a[3][0])
								)+
		 a[0][3] * ( 
								a[1][0] * (+a[2][1]*a[3][2] - a[2][2]*a[3][1]) +
								a[1][1] * (-a[2][0]*a[3][2] + a[2][2]*a[3][0]) +
								a[1][2] * (+a[2][0]*a[3][1] - a[2][1]*a[3][0])
								));

	return det;

}

/*---------------------------------------------------------------
 *	inverse_4x4()
 * get the inverse of a square 4x4 matrix
 * returns determinant
 *--------------------------------------------------------------*/
double
inverse_4x4( double **a, double **b)
{
	double det;

	det = 
		- a[0][0] * a[1][1] * a[2][2] * a[3][3] 
		+ a[0][0] * a[1][1] * a[2][3] * a[3][2] 
		+ a[0][0] * a[2][1] * a[1][2] * a[3][3] 
		- a[0][0] * a[2][1] * a[1][3] * a[3][2]
		- a[0][0] * a[3][1] * a[1][2] * a[2][3] 
		+ a[0][0] * a[3][1] * a[1][3] * a[2][2]

		+ a[1][0] * a[0][1] * a[2][2] * a[3][3] 
		- a[1][0] * a[0][1] * a[2][3] * a[3][2] 
		- a[1][0] * a[2][1] * a[0][2] * a[3][3] 
		+ a[1][0] * a[2][1] * a[0][3] * a[3][2] 
		+ a[1][0] * a[3][1] * a[0][2] * a[2][3] 
		- a[1][0] * a[3][1] * a[0][3] * a[2][2]

		- a[2][0] * a[0][1] * a[1][2] * a[3][3] 
		+ a[2][0] * a[0][1] * a[1][3] * a[3][2] 
		+ a[2][0] * a[1][1] * a[0][2] * a[3][3] 
		- a[2][0] * a[1][1] * a[0][3] * a[3][2] 
		- a[2][0] * a[3][1] * a[0][2] * a[1][3] 
		+ a[2][0] * a[3][1] * a[0][3] * a[1][2] 

		+ a[3][0] * a[0][1] * a[1][2] * a[2][3] 
		- a[3][0] * a[0][1] * a[1][3] * a[2][2] 
		- a[3][0] * a[1][1] * a[0][2] * a[2][3] 
		+ a[3][0] * a[1][1] * a[0][3] * a[2][2] 
		+ a[3][0] * a[2][1] * a[0][2] * a[1][3] 
		- a[3][0] * a[2][1] * a[0][3] * a[1][2] ;


	b[0][0] = - a[1][1] * (a[2][2]*a[3][3] - a[2][3] * a[3][2])
						+ a[2][1] * (a[1][2]*a[3][3] - a[1][3] * a[3][2])
						- a[3][1] * (a[1][2]*a[2][3] - a[1][3] * a[2][2]);

	b[0][1] = + a[0][1] * (a[2][2]*a[3][3] - a[2][3] * a[3][2])
						- a[2][1] * (a[0][2]*a[3][3] - a[0][3] * a[3][2])
						+ a[3][1] * (a[0][2]*a[2][3] - a[0][3] * a[2][2]);
	
	b[0][2] = - a[0][1] * (a[1][2]*a[3][3] - a[1][3] * a[3][2])
						+ a[1][1] * (a[0][2]*a[3][3] - a[0][3] * a[3][2])
						- a[3][1] * (a[0][2]*a[1][3] - a[0][3] * a[1][2]);
	
	b[0][3] = + a[0][1] * (a[1][2]*a[2][3] - a[1][3] * a[2][2])
						- a[1][1] * (a[0][2]*a[2][3] - a[0][3] * a[2][2])
						+ a[2][1] * (a[0][2]*a[1][3] - a[0][3] * a[1][2]);

	
	b[1][0] = + a[1][0] * (a[2][2]*a[3][3] - a[2][3] * a[3][2])
						- a[2][0] * (a[1][2]*a[3][3] - a[1][3] * a[3][2])
						+ a[3][0] * (a[1][2]*a[2][3] - a[1][3] * a[2][2]);
	
	b[1][1] = - a[0][0] * (a[2][2]*a[3][3] - a[2][3] * a[3][2])
						+ a[2][0] * (a[0][2]*a[3][3] - a[0][3] * a[3][2])
						- a[3][0] * (a[0][2]*a[2][3] - a[0][3] * a[2][2]);
	
	b[1][2] = + a[0][0] * (a[1][2]*a[3][3] - a[1][3] * a[3][2])
						- a[1][0] * (a[0][2]*a[3][3] - a[0][3] * a[3][2])
						+ a[3][0] * (a[0][2]*a[1][3] - a[0][3] * a[1][2]);
	
	b[1][3] = - a[0][0] * (a[1][2]*a[2][3] - a[1][3] * a[2][2])
						+ a[1][0] * (a[0][2]*a[2][3] - a[0][3] * a[2][2])
						- a[2][0] * (a[0][2]*a[1][3] - a[0][3] * a[1][2]);


	b[2][0] = - a[1][0] * (a[2][1]*a[3][3] - a[2][3] * a[3][1])
						+ a[2][0] * (a[1][1]*a[3][3] - a[1][3] * a[3][1])
						- a[3][0] * (a[1][1]*a[2][3] - a[1][3] * a[2][1]);

	b[2][1] = + a[0][0] * (a[2][1]*a[3][3] - a[2][3] * a[3][1])
						- a[2][0] * (a[0][1]*a[3][3] - a[0][3] * a[3][1])
						+ a[3][0] * (a[0][1]*a[2][3] - a[0][3] * a[2][1]);
	
	b[2][2] = - a[0][0] * (a[1][1]*a[3][3] - a[1][3] * a[3][1])
						+ a[1][0] * (a[0][1]*a[3][3] - a[0][3] * a[3][1])
						- a[3][0] * (a[0][1]*a[1][3] - a[0][3] * a[1][1]);
	
	b[2][3] = + a[0][0] * (a[1][1]*a[2][3] - a[1][3] * a[2][1])
						- a[1][0] * (a[0][1]*a[2][3] - a[0][3] * a[2][1])
						+ a[2][0] * (a[0][1]*a[1][3] - a[0][3] * a[1][1]);

	
	b[3][0] = + a[1][0] * (a[2][1]*a[3][2] - a[2][2] * a[3][1])
						- a[2][0] * (a[1][1]*a[3][2] - a[1][2] * a[3][1])
						+ a[3][0] * (a[1][1]*a[2][2] - a[1][2] * a[2][1]);
	
	b[3][1] = - a[0][0] * (a[2][1]*a[3][2] - a[2][2] * a[3][1])
						+ a[2][0] * (a[0][1]*a[3][2] - a[0][2] * a[3][1])
						- a[3][0] * (a[0][1]*a[2][2] - a[0][2] * a[2][1]);
	
	b[3][2] = + a[0][0] * (a[1][1]*a[3][2] - a[1][2] * a[3][1])
						- a[1][0] * (a[0][1]*a[3][2] - a[0][2] * a[3][1])
						+ a[3][0] * (a[0][1]*a[1][2] - a[0][2] * a[1][1]);
	
	b[3][3] = - a[0][0] * (a[1][1]*a[2][2] - a[1][2] * a[2][1])
						+ a[1][0] * (a[0][1]*a[2][2] - a[0][2] * a[2][1])
						- a[2][0] * (a[0][1]*a[1][2] - a[0][2] * a[1][1]);

	return det;
}

/*---------------------------------------------------------------
 *	coFactor_3x3()
 * Find the coFactor matrix of a square matrix
 *--------------------------------------------------------------*/
void
coFactor_3x3( double **a, double **b)
{
	b[0][0] = +( a[1][1] * a[2][2] - a[2][1] * a[1][2]);
	b[1][0] = -( a[1][0] * a[2][2] - a[1][2] * a[2][0]);
	b[2][0] = +( a[1][0] * a[2][1] - a[1][1] * a[2][0]);
	b[0][1] = -( a[0][1] * a[2][2] - a[0][2] * a[2][1]);
	b[1][1] = +( a[0][0] * a[2][2] - a[2][0] * a[0][2]);
	b[2][1] = -( a[0][0] * a[2][1] - a[0][1] * a[2][0]);
	b[0][2] = +( a[0][1] * a[1][2] - a[0][2] * a[1][1]);
	b[1][2] = -( a[0][0] * a[1][2] - a[0][2] * a[1][0]);
	b[2][2] = +( a[0][0] * a[1][1] - a[0][1] * a[1][0]);
}

/*---------------------------------------------------------------
 *	coFactor_2x2()
 * Find the coFactor matrix of a square matrix
 *--------------------------------------------------------------*/
void
coFactor_2x2( double **a, double **b)
{
	b[0][0] = +a[1][1];
	b[1][0] = -a[0][1];
	b[0][1] = -a[1][0];
	b[1][1] = +a[0][0];
}

/*---------------------------------------------------------------
 *	multiplication of squared matrices
 * A = B * C
 *--------------------------------------------------------------*/
void
multmatsq( int M, double **a, double **b, double **c)
{
	int i, j, n;
	for (i = 0; i < M; i++)
	{
		for (j = 0; j < M; j++)
		{
			a[i][j] = 0;
			for (n = 0; n < M; n++)
			{
				a[i][j] += b[i][n] * c[n][j];
			}
		}
	}
}

/*---------------------------------------------------------------
 *	multiplication of squared matrices
 * A = B * C^T
 *--------------------------------------------------------------*/
void
multmatsqT( int M, double **a, double **b, double **c)
{
	int i, j, n;
	for (i = 0; i < M; i++)
	{
		for (j = 0; j < M; j++)
		{
			a[i][j] = 0;
			for (n = 0; n < M; n++)
			{
				a[i][j] += b[i][n] * c[j][n];
			}
		}
	}
}
